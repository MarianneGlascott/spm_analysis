# Project:     SPM Analysis - Impact on kelp zoospore motility
# Script:      00_project_setup.R
# Author:      Marianne Glascott
# Affiliation: School of Life Sciences, University of Sussex
# Date:        2026-02-10
# Purpose:
#   - Ensure renv is initialized (reproducible environment)
#   - Create standard folder structure
#   - Write shared style + helper functions (R/kelp_style.R, R/helpers.R)
#   - Write outputs/setup_log.txt
# Outputs (file-based):
#   - renv.lock (updated via renv::snapshot)
#   - outputs/setup_log.txt
#   - R/kelp_style.R
#   - R/helpers.R

# ---- Base logger (works before here is installed) ----
log_base <- function(msg, log_file = "outputs/setup_log.txt") {
  ts <- format(Sys.time(), "%Y-%m-%d %H:%M:%S")
  line <- paste0("[", ts, "] ", msg)
  cat(line, "\n")
  dir.create(dirname(log_file), recursive = TRUE, showWarnings = FALSE)
  cat(line, "\n", file = log_file, append = TRUE)
}

log_base("Starting 00_project_setup.R")

# ---- Ensure renv exists ----
if (!requireNamespace("renv", quietly = TRUE)) {
  log_base("Installing renv from CRAN...")
  install.packages("renv")
}

# ---- Initialize renv if needed (robust check) ----
renv_initialized <- file.exists("renv/activate.R") || file.exists("renv/settings.json")

if (!renv_initialized) {
  log_base("renv not initialized (renv/activate.R not found). Running renv::init(bare = TRUE)...")
  renv::init(bare = TRUE)
  
  # renv will restart the session; stop so user re-runs cleanly
  log_base("renv initialized; session restarted by renv. Please re-run scripts/00_project_setup.R.")
  stop("renv initialized and session restarted. Re-run scripts/00_project_setup.R.")
} else {
  log_base("renv appears initialized.")
}

# ---- Ensure required packages are installed inside renv library ----
install_if_missing <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    log_base(paste0("Installing '", pkg, "' into renv library..."))
    renv::install(pkg)
  }
}

install_if_missing("here")
install_if_missing("ggplot2")
install_if_missing("readr")
install_if_missing("dplyr")

suppressPackageStartupMessages(library(here))
log_base(paste0("here() project root: ", here::here(".")))

# ---- Create standard folder structure ----
dirs_to_create <- c(
  here::here("outputs"),
  here::here("scripts"),
  here::here("data_raw"),
  here::here("data_processed"),
  here::here("figures"),
  here::here("tables"),
  here::here("models"),
  here::here("logs"),
  here::here("R")
)

for (d in dirs_to_create) {
  if (!dir.exists(d)) dir.create(d, recursive = TRUE, showWarnings = FALSE)
}
log_base("Folder structure created/verified.")

# ---- Write shared style + helper files ----
style_file   <- here::here("R", "kelp_style.R")
helpers_file <- here::here("R", "helpers.R")

style_contents <- c(
  "# Auto-generated by scripts/00_project_setup.R",
  "suppressPackageStartupMessages({",
  "  library(ggplot2)",
  "})",
  "",
  "# Global ggplot theme",
  "Kelp_theme <- function(base_size = 11) {",
  "  ggplot2::theme_minimal(base_size = base_size) +",
  "    ggplot2::theme(",
  "      panel.grid.minor = ggplot2::element_blank(),",
  "      plot.title.position = 'plot',",
  "      legend.position = 'right',",
  "      strip.text = ggplot2::element_text(face = 'bold')",
  "    )",
  "}",
  "",
  "# Named colour palette (edit as you iterate)",
  "kelp_palette <- c(",
  "  kelp_green = '#2E7D32',",
  "  kelp_teal  = '#00796B',",
  "  kelp_blue  = '#1565C0',",
  "  kelp_amber = '#FF8F00',",
  "  kelp_red   = '#C62828',",
  "  kelp_grey  = '#455A64'",
  ")",
  ""
)

helpers_contents <- c(
  "# Auto-generated by scripts/00_project_setup.R",
  "suppressPackageStartupMessages({",
  "  library(here)",
  "  library(ggplot2)",
  "  library(readr)",
  "})",
  "",
  "# Log messages to a file (default: outputs/run_log.txt)",
  "log_message <- function(msg, log_file = here::here('outputs', 'run_log.txt')) {",
  "  ts <- format(Sys.time(), '%Y-%m-%d %H:%M:%S')",
  "  line <- paste0('[', ts, '] ', msg)",
  "  cat(line, '\\n')",
  "  dir.create(dirname(log_file), recursive = TRUE, showWarnings = FALSE)",
  "  cat(line, '\\n', file = log_file, append = TRUE)",
  "  invisible(line)",
  "}",
  "",
  "# Save a ggplot to disk",
  "save_plot <- function(p, filename, width = 7, height = 5, dpi = 300, dir = here::here('figures')) {",
  "  dir.create(dir, recursive = TRUE, showWarnings = FALSE)",
  "  out <- file.path(dir, filename)",
  "  ggplot2::ggsave(filename = out, plot = p, width = width, height = height, dpi = dpi, units = 'in')",
  "  log_message(paste0('Saved plot: ', out))",
  "  out",
  "}",
  "",
  "# Save a table to disk (csv/tsv by extension; otherwise .csv fallback)",
  "save_table <- function(df, filename, dir = here::here('tables')) {",
  "  dir.create(dir, recursive = TRUE, showWarnings = FALSE)",
  "  out <- file.path(dir, filename)",
  "  ext <- tolower(tools::file_ext(out))",
  "  if (ext == 'csv') {",
  "    readr::write_csv(df, out)",
  "  } else if (ext == 'tsv') {",
  "    readr::write_tsv(df, out)",
  "  } else {",
  "    out <- paste0(out, '.csv')",
  "    readr::write_csv(df, out)",
  "  }",
  "  log_message(paste0('Saved table: ', out))",
  "  out",
  "}",
  ""
)

writeLines(style_contents, style_file)
writeLines(helpers_contents, helpers_file)

log_base(paste0("Wrote: ", style_file))
log_base(paste0("Wrote: ", helpers_file))

# ---- Snapshot environment (updates renv.lock) ----
log_base("Running renv::snapshot(prompt = FALSE)...")
renv::snapshot(prompt = FALSE)
log_base("00_project_setup.R complete.")
